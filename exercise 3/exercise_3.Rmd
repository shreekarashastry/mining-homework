---
title: "ECO395M: Exercise 3"
author: "Steven Kim and Shreekara Shastry"
date: ""
output:
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(knitr)
library(rsample)
library(pdp)
library(rpart)
library(rpart.plot)
library(gbm)
library(randomForest)
```

## What causes what?

1. You can't just get data from a few different cities and run the regressions of “Crime” on “Police” because cities have incentives to hire more cops when there is an increased number of crimes. Because of this, it would look like “Crime” is positively correlated to “Police” when there is no reason to believe there is a causal relationship.

How were the researchers from UPenn able to isolate this effect? Briefly describe their approach and discuss their result in the “Table 2” below, from the researchers' paper.

2. The researchers from UPenn were able to isolate this effect because the District of Columbia had the policy where they increased  “Police” when there is an increased risk of terrorism, which is believed to be unrelated to the street crime rates. The result in the “Table 2” below says that there is a statistically significant negative relationship between the “High Alert” and “Crime”, implying that the increased number of cops because of the possible terrorist risk decreased the crime rates. This holds true even after controlling for the ridership of Metro.

3. They had to control for Metro ridership because, if “Crime” decreased because there were less people on the streets, that would not neccesarily mean the rate of crime decreasing because of the increased number of cops. This would be of concern if people stayed home because of the terrorist alert. However, it did not turn out to be true. They were trying to capture the effect of the decrease of normal human activity in the city on the number of crime incidents.

4. The model being estimated here is the effect of “High Alert”, controlled for “Midday Ridership”, by districts (if it is district 1 or not). The conclusion is that the effect of “High Alert” is only significant in the first police district area.


## Tree modeling: dengue cases

```{r}
dengue = read_csv('dengue.csv') %>% drop_na()

dengue_split = initial_split(dengue, 0.8)
dengue_train = training(dengue_split)
dengue_test = testing(dengue_split)

# CART
dengue.tree = rpart(total_cases ~ season + specific_humidity + tdtr_k + precipitation_amt, 
                    data=dengue_train,
                    control = rpart.control(cp = 0.002, minsplit=30))

rpart.plot(dengue.tree, digits=-5, type=4, extra=1)

cp_1se = function(my_tree) {
  out = as.data.frame(my_tree$cptable)
  thresh = min(out$xerror + out$xstd)
  cp_opt = max(out$CP[out$xerror <= thresh])
  cp_opt
}

cp_1se(dengue.tree)

prune_1se = function(my_tree) {
  out = as.data.frame(my_tree$cptable)
  thresh = min(out$xerror + out$xstd)
  cp_opt = max(out$CP[out$xerror <= thresh])
  prune(my_tree, cp=cp_opt)
}

dengue.prune = prune_1se(dengue.tree)

# Random Forest
dengue.forest = randomForest(total_cases ~ season + specific_humidity + tdtr_k + precipitation_amt, 
                    data=dengue_train,
                    importance = TRUE, na.action=na.omit)

plotcp(dengue.tree)

# Gradient Boosting
dengue.gbs = gbm(total_cases ~ specific_humidity + tdtr_k + precipitation_amt, 
                    data=dengue_train, distribution = "gaussian",n.trees = 10000,
                  shrinkage = 0.01, interaction.depth = 4)

modelr::rmse(dengue.tree, dengue_test)
modelr::rmse(dengue.prune, dengue_test)
modelr::rmse(dengue.forest, dengue_test)
modelr::rmse(dengue.gbs, dengue_test)

# Looks like random Forest is the best and better than even the pruned tree by a slim margin
partialPlot(dengue.forest, as.data.frame(dengue_test), 'specific_humidity', las=1)
partialPlot(dengue.forest, as.data.frame(dengue_test), 'precipitation_amt', las=1)
partialPlot(dengue.forest, as.data.frame(dengue_test), 'tdtr_k', las=1)
```

## Predictive model building: green certification

```{r}
greenbuildings = read_csv("greenbuildings.csv")

```


## Predictive model building: California housing

```{r}
CAhousing = read_csv("CAhousing.csv")
```

The model does the prediction pretty well. It only got `r abs(as.integer(hotels_final[21, 3]))` predictions wrong in total out of 4999 observations though if you look at each folds individually there is a difference as in sometimes we have negative and sometimes positive values, but in total it all averages out to `r abs(as.integer(hotels_final[21, 3]))`. 

