---
title: "ECO395M: Exercise 1"
author: "Steven Kim and Shreekara Shastry"
date: ""
output:
  md_document:
    variant: markdown_github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(rsample)
library(caret)
library(modelr)
library(knitr)
library(mosaic)
library(parallel)
library(foreach)
```

## 1) Data visualization

## 2) Saratoga house prices

```{r}
data(SaratogaHouses)

K_folds = 5

saratoga_folds = crossv_kfold(SaratogaHouses, k=K_folds)

#linear model

models = map(saratoga_folds$train, ~ lm(price ~ . - pctCollege - sewer - newConstruction + rooms:bathrooms, data = ., use.all=FALSE))
errs = map2_dbl(models, saratoga_folds$test, modelr::rmse)


#knn model

#scale
saratoga_scaled = SaratogaHouses %>%
  mutate(across(c(lotSize, age, landValue, livingArea, pctCollege, bedrooms, fireplaces, bathrooms, rooms), scale))

saratoga_scaled_folds = crossv_kfold(saratoga_scaled, k=K_folds)

k_grid = c(2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 
           30, 35, 40, 45, 50, 60, 70, 80, 90, 100, 125, 150, 175, 200, 250, 300)

cv_grid = foreach(k = k_grid, .combine='rbind') %dopar% {
  models = map(saratoga_scaled_folds$train, ~ knnreg(price ~ . - pctCollege - sewer - newConstruction, k=k, data = ., use.all=FALSE))
  errs = map2_dbl(models, saratoga_scaled_folds$test, modelr::rmse)
  c(k=k, err = mean(errs), std_err = sd(errs)/sqrt(K_folds))
} %>% as.data.frame

ggplot(cv_grid) + 
  geom_point(aes(x=k, y=err)) + 
  geom_errorbar(aes(x=k, ymin = err-std_err, ymax = err+std_err)) + 
  scale_x_log10()

cv_grid_final = cv_grid %>% filter(err == min(cv_grid$err))
rownames(cv_grid_final) = c("KNN Model")
cv_grid_final = rbind(cv_grid_final, data.frame(k="NA", err = mean(errs), std_err = sd(errs)/sqrt(K_folds),  row.names = c("Linear Model"))) %>% dplyr::select(-std_err)
col.names(cv_grid_final) = c("k", "rMSE")
kable(cv_grid_final)
```

choose k = `r cv_grid_final[1,1]`, standard error is smaller for the linear model.


## 3) Classification and retrospective sampling

## 4) Children and hotel reservations

```{r}
hotels_dev = read_csv("hotels_dev.csv")
hotels_val = read_csv("hotels_val.csv")

K_folds = 5

hotels_dev_folds = crossv_kfold(hotels_dev, k=K_folds)

k_grid = c(2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 
           30, 35, 40, 45, 50, 60, 70, 80, 90, 100, 125, 150, 175, 200, 250, 300)

cv_grid_hotel_1 = foreach(k = k_grid, .combine='rbind') %dopar% {
  models = map(hotels_dev_folds$train, ~ caret::knn3(children ~ market_segment + adults + customer_type + is_repeated_guest, k=k, data = ., use.all=FALSE))
  errs = map2_dbl(models, hotels_dev_folds$test, modelr::rmse)
  c(k=k, err = mean(errs), std_err = sd(errs)/sqrt(K_folds))
} %>% as.data.frame

ggplot(cv_grid_hotel_1) + 
  geom_point(aes(x=k, y=err)) + 
  geom_errorbar(aes(x=k, ymin = err-std_err, ymax = err+std_err)) + 
  scale_x_log10()

cv_grid_hotel_1_final = cv_grid %>% filter(err == min(cv_grid_hotel_1$err))

cv_grid_hotel_2 = foreach(k = k_grid, .combine='rbind') %dopar% {
  models = map(hotels_dev_folds$train, ~ karet::knn3(children ~ -arrival_date, k=k, data = ., use.all=FALSE))
  errs = map2_dbl(models, hotel_dev_folds$test, modelr::rmse)
  c(k=k, err = mean(errs), std_err = sd(errs)/sqrt(K_folds))
} %>% as.data.frame

ggplot(cv_grid_hotel_2) + 
  geom_point(aes(x=k, y=err)) + 
  geom_errorbar(aes(x=k, ymin = err-std_err, ymax = err+std_err)) + 
  scale_x_log10()

cv_grid_hotel_2_final = cv_grid %>% filter(err == min(cv_grid_hotel_2$err))

hotel_linear_models = map(hotel_dev_folds$train, ~ lm(children ~ market_segment + adults + customer_type + is_repeated_guest, data = ., use.all=FALSE))
hotel_errs = map2_dbl(models, saratoga_folds$test, modelr::rmse)

cv_grid_hotel_final = cv_grid_hotel_1_final %>% rbind(cv_grid_hotel_2_final) %>% rbind(data.frame(k="NA", err = mean(hotel_errs), std_err = sd(hotel_errs)/sqrt(K_folds))) %>% dplyr::select(-std_err)
colnames(cv_grid_hotel_final) = c("k", "rMSE")
rownames(cv_grid_hotel_final) = c("Baseline 1", "Baseline 2", "Linear Model")
```


